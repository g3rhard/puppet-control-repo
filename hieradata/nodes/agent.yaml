---
classes:
  - nginx
  - php
  # - test_nginx

nginx::config::vhost_purge: true
nginx::config::confd_purge: true

# TODO:
# vdomain: example.com

nginx::resource::server:
  'test-proxy.local':
    ensure: present
    listen_port: 8088
    www_root: '/var/www/localhost'
  'kibana.local':
    listen_port: 80,
    proxy: 'http://localhost:5601'

nginx::nginx_servers:
    'devops-alldomains':
        server_name:
            - '~^(?<fqdn>.+?)$'
        www_root: '/var/www/$fqdn'
        index_files:
            - 'index.php'
        try_files:
            - '$uri'
            - '$uri/'
            - '/index.php?$args'
        access_log: '/var/log/nginx/devops-alldomains-access.log'
        error_log: '/var/log/nginx/devops-alldomains-error.log'
    'devops-alldomains-ssl':
        server_name:
            - '~^(?<fqdn>.+?)$'
        listen_port: 443
        ssl_port: 443
        www_root: '/var/www/$fqdn'
        ssl: true
        ssl_key: '/etc/ssl/www/$fqdn.key'
        ssl_cert: '/etc/ssl/www/$fqdn.crt'
        index_files:
            - 'index.php'
        try_files:
            - '$uri'
            - '$uri/'
            - '/index.php?$args'
        access_log: '/var/log/nginx/devops-alldomains-access-ssl.log'
        error_log: '/var/log/nginx/devops-alldomains-error-ssl.log'

nginx::nginx_locations:
    'devops-alldomains-loc':
        location: '~ \.php$'
        www_root: '/var/www/$fqdn'
        server: 'devops-alldomains'
        fastcgi: '127.0.0.1:9000'
        fastcgi_split_path: '^(.+\.php)(/.*)$'
        fastcgi_index: 'index.php'
        fastcgi_param:
            'SCRIPT_FILENAME': '$document_root$fastcgi_script_name'
    'devops-alldomains-ssl-loc':
        location: '~ \.php$'
        www_root: '/var/www/$fqdn'
        server: 'devops-alldomains-ssl'
        ssl: true
        ssl_only: true
        fastcgi: 'unix:/var/run/php7-fpm.sock'
        fastcgi_split_path: '^(.+\.php)(/.*)$'
        fastcgi_index: 'index.php'
        fastcgi_param:
            'SCRIPT_FILENAME': '$document_root$fastcgi_script_name'

php::ensure: present
php::manage_repos: false
php::fpm: true
php::fpm_user: 'www-data'
php::fpm_group: 'www-data'
php::dev: true
php::composer: true
php::pear: true
php::phpunit: false
php::settings:
  'PHP/max_execution_time': '90'
  'PHP/max_input_time': '300'
  'PHP/memory_limit': '64M'
  'PHP/post_max_size': '32M'
  'PHP/upload_max_filesize': '32M'
  'Date/date.timezone': 'UTC'
php::extensions:
  bcmath: {}
  curl: {}
  intl: {}
  gd: {}
  json: {}
  mbstring: {}
  mysql: {}
  pinba: {}
  readline: {}
  xdebug: {}
  xml: {}
  xmlrpc: {}
  zip: {}
  # imagick: {}
  # memcached: {}
  apcu:
    settings:
      'apc/stat': 1
      'apc/stat_ctime': 1
    sapi: 'fpm'
php::fpm::pools:
  www:
    listen: '127.0.0.1:9000'
